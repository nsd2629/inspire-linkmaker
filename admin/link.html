<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Link Maker</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg:#0d1117; --panel:#0f1624; --panel2:#0c1320; --fg:#e6edf3; --muted:#95a1b2; --accent:#7aa2ff; --line:#1e2a3a;
    --btn:#1f6feb; --btn2:#263241;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f7f8fb; --panel:#fff; --panel2:#f4f7fb; --fg:#0c1220; --muted:#5b6472; --accent:#335fff; --line:#e7edf5; --btn:#3556ff; --btn2:#eef2f9;}
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,"Apple SD Gothic Neo","Noto Sans KR",sans-serif}
  h1{font-size:20px;margin:18px 0 14px 0}
  .container{display:grid;grid-template-columns: minmax(360px,520px) 1fr; gap:18px; padding:18px}
  .panel{background:linear-gradient(180deg, var(--panel), var(--panel2)); border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.18)}
  label{display:block;color:var(--muted);margin:12px 0 6px}
  input,select,textarea{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#0a1220; color:var(--fg); outline:none}
  select{appearance:none; background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%2395a1b2"><path d="M4 6l4 4 4-4"/></svg>'); background-repeat:no-repeat; background-position: calc(100% - 10px) center}
  input::placeholder{color:#6f7a8a}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px; border:1px solid var(--line); background:var(--btn2); color:var(--fg); cursor:pointer; user-select:none}
  .btn.primary{ background:var(--btn); border-color:#21408f }
  .muted{color:var(--muted)}
  .flex{display:flex; gap:10px; align-items:center}
  .right{display:flex; justify-content:flex-end}
  .badge{display:inline-block; padding:3px 8px; border-radius:999px; background:#1b2840; color:#c8d4ea; font-size:12px}
  .dropdown{position:absolute; background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:6px; width:100%; max-height:240px; overflow:auto; display:none; z-index:20}
  .dropdown .item{padding:8px 10px;border-radius:10px;display:flex;gap:8px;align-items:center;cursor:pointer}
  .dropdown .item:hover{background:rgba(125,150,255,.1)}
  .combo{position:relative}
  .preview{height:520px; border-radius:16px; border:1px solid var(--line); background:#0b1220; overflow:hidden}
  iframe{border:0;width:100%;height:100%;background:#fff}
  .kv{display:grid; grid-template-columns:160px 1fr; gap:8px; align-items:center}
  .grid{display:grid; gap:8px}
  .hr{height:1px; background:var(--line); margin:14px 0}
</style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h1>Link Maker</h1>
      <div class="grid">
        <div class="row">
          <div>
            <label>환경</label>
            <select id="env">
              <option value="staging" selected>staging</option>
              <option value="prod">prod</option>
            </select>
          </div>
          <div>
            <label>card</label>
            <select id="card">
              <option value="healing" selected>healing</option>
              <option value="hanlove">hanlove</option>
            </select>
          </div>
        </div>

        <!-- healing 전용 -->
        <div id="healingBlock">
          <div class="row">
            <div>
              <label>주문자</label>
              <input id="customer" placeholder="예) Grace, Kim.M.J …">
            </div>
            <div>
              <label>그룹(list)</label>
              <input id="list" placeholder="default">
            </div>
          </div>
          <label>그룹 검색/선택</label>
          <div class="combo">
            <input id="healingGroupSearch" placeholder="예) default, bible30, custom-…">
            <div id="healingGroupDropdown" class="dropdown"></div>
          </div>
          <div id="healingGroupCount" class="muted" style="margin-top:6px"></div>
        </div>

        <div class="row">
          <div>
            <label>mode</label>
            <select id="mode">
              <option value="shuffle" selected>shuffle</option>
              <option value="daily">daily</option>
              <option value="fixed">fixed</option>
            </select>
          </div>
          <div>
            <label>id (mode=fixed일 때)</label>
            <input id="itemId" placeholder="HL-002" disabled>
          </div>
        </div>

        <div class="row">
          <div class="kv"><span>showCredit</span><input id="showCredit" type="checkbox"></div>
          <div class="kv"><span>UTM 기본값</span><input id="utm" type="checkbox" checked></div>
        </div>

        <div>
          <label>버전 v=</label>
          <input id="v" value="1">
        </div>

        <div class="row">
          <div>
            <label>홍보 링크(promo)</label>
            <input id="promo" placeholder="https://your-landing.example">
          </div>
          <div>
            <label>버튼 라벨</label>
            <input id="promoText" value="Open Healing Message">
          </div>
        </div>

        <div class="right">
          <button id="build" class="btn primary">링크 생성</button>
        </div>

        <div class="hr"></div>

        <div>
          <label>단축 URL</label>
          <div class="row">
            <input id="slug" placeholder="slug(비우면 자동 생성)">
            <button class="btn" id="makeShort">단축 URL 생성</button>
          </div>
          <div class="row">
            <input id="shortUrl" placeholder="https://…/s/&lt;slug&gt;" readonly>
            <div class="flex right">
              <button class="btn" id="copyUrl">URL 복사</button>
              <button class="btn" id="copyShort">단축URL 복사</button>
              <button class="btn" id="dlShort">단축URL 다운로드(.txt)</button>
            </div>
          </div>
        </div>

      </div>
    </div>
    <div class="panel">
      <div class="preview">
        <iframe id="preview" title="preview"></iframe>
      </div>
    </div>
  </div>

<script>
const elEnv = document.getElementById('env');
const elCard = document.getElementById('card');
const elList = document.getElementById('list');
const elMode = document.getElementById('mode');
const elId = document.getElementById('itemId');
const elShowCredit = document.getElementById('showCredit');
const elUTM = document.getElementById('utm');
const elV = document.getElementById('v');
const elPromo = document.getElementById('promo');
const elPromoText = document.getElementById('promoText');
const elCustomer = document.getElementById('customer');
const elSlug = document.getElementById('slug');
const elShort = document.getElementById('shortUrl');
const elPreview = document.getElementById('preview');

// healing 그룹 검색
const hgSearch = document.getElementById('healingGroupSearch');
const hgBox = document.getElementById('healingGroupDropdown');
const hgCount = document.getElementById('healingGroupCount');
let HEALING_GROUPS = {items:[]};

async function loadHealingGroups(){
  try{
    const r = await fetch('/data/healing/groups.json',{cache:'no-store'});
    if(!r.ok) throw 0;
    const j = await r.json();
    const items = (j.groups||[]).map(g=>({key:(g.key||'').trim(), name:(g.name||'').trim(), desc:(g.desc||'').trim(), count:g.count||0}))
      .filter(g=>g.key);
    return {items};
  }catch(e){ return {items:[]}; }
}
function renderHealingDropdown(items, kw=''){
  hgBox.innerHTML='';
  const lc=(kw||'').trim().toLowerCase();
  const filtered = items.filter(it=> !lc || it.key.toLowerCase().includes(lc) || it.name.toLowerCase().includes(lc)).slice(0,200);
  filtered.forEach(it=>{
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `<span>${it.name} <span class="badge">${it.key}</span></span><span class="muted" style="margin-left:auto">${it.count||''}</span>`;
    row.onclick=()=>{ elList.value=it.key; hgBox.style.display='none'; rebuild(); };
    hgBox.appendChild(row);
  });
  hgCount.textContent = `총 ${items.length}개 · 필터 ${filtered.length}개`;
  hgBox.style.display = filtered.length?'block':'none';
}
document.addEventListener('click', (e)=>{ if(!hgBox.contains(e.target) && e.target!==hgSearch){ hgBox.style.display='none'; } });

function buildURL(){
  const env = elEnv.value; const card = elCard.value;
  let pageBase = '/link/';
  if(card==='healing'){ pageBase='/link/healing.html'; }
  const p = new URL(pageBase, location.origin);
  p.searchParams.set('card', card);
  const list = (elList.value||'').trim(); if(list) p.searchParams.set('list', list);
  const mode = elMode.value; if(mode) p.searchParams.set('mode', mode);
  const id = (elId.value||'').trim(); if(mode==='fixed' && id) p.searchParams.set('id', id);
  if(elShowCredit.checked) p.searchParams.set('showCredit','true');
  const promo=(elPromo.value||'').trim(); if(promo) p.searchParams.set('promo', promo);
  const btn=(elPromoText.value||'').trim(); if(btn) p.searchParams.set('btn', btn);
  const customer=(elCustomer.value||'').trim(); if(customer) p.searchParams.set('customer', customer);
  const v=(elV.value||'').trim(); if(v) p.searchParams.set('v', v);
  if(elUTM.checked){
    p.searchParams.set('utm_source','linkmaker');
    p.searchParams.set('utm_medium','qr');
  }
  return p.toString();
}

function rebuild(){
  const url = buildURL();
  elPreview.src = url;
}

function wire(){
  const ids=['env','card','list','mode','itemId','showCredit','utm','v','promo','promoText','customer'];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', rebuild);
    el.addEventListener('change', rebuild);
  });
  document.getElementById('build').addEventListener('click', rebuild);

  // mode → id 활성화
  elMode.addEventListener('change', ()=>{
    elId.disabled = elMode.value!=='fixed';
  });

  // healing 그룹 로드/검색
  loadHealingGroups().then(j=>{ HEALING_GROUPS=j; });
  hgSearch.addEventListener('focus', ()=>renderHealingDropdown(HEALING_GROUPS.items, hgSearch.value));
  hgSearch.addEventListener('input', ()=>renderHealingDropdown(HEALING_GROUPS.items, hgSearch.value));

  // Init
  elId.disabled = elMode.value!=='fixed';
  rebuild();
}

wire();
</script>
</body>
</html>
